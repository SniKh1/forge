# 安全与质量规范

> **Purpose**: 整合安全检查、代码风格、质量清单为统一规范，适用于所有开发场景。

---

## 一、安全检查（强制）

### 1.1 提交前必检项

- [ ] 无硬编码密钥/密码/token
- [ ] 不提交 .env / credentials 等敏感文件
- [ ] 用户输入在系统边界已验证
- [ ] SQL 注入防护（参数化查询）
- [ ] XSS 防护（HTML 转义）
- [ ] CSRF 保护已启用
- [ ] 认证/授权已验证
- [ ] 错误信息不泄露敏感数据

### 1.2 密钥管理

```typescript
// 禁止：硬编码密钥
const apiKey = "sk-proj-xxxxx"

// 正确：环境变量
const apiKey = process.env.OPENAI_API_KEY
if (!apiKey) {
  throw new Error('OPENAI_API_KEY not configured')
}
```

### 1.3 安全响应协议

发现安全问题时：
1. **立即停止**当前工作
2. 使用 `security-reviewer` Agent 分析
3. 修复 CRITICAL 问题后再继续
4. 轮换任何暴露的密钥
5. 审查整个代码库是否有类似问题

---

## 二、代码风格（强制）

### 2.1 核心原则

| 原则 | 说明 |
|------|------|
| KISS | 能简单就不复杂 |
| DRY | 零容忍重复，必须复用 |
| 不可变 | 创建新对象，不修改原对象 |
| 保护调用链 | 修改函数签名时同步更新所有调用点 |

### 2.2 不可变性（CRITICAL）

```javascript
// 错误：直接修改
function updateUser(user, name) {
  user.name = name  // MUTATION!
  return user
}

// 正确：创建新对象
function updateUser(user, name) {
  return { ...user, name }
}
```

### 2.3 文件组织

- 多个小文件 > 少数大文件
- 200-400 行典型，800 行上限
- 按功能/领域组织，而非按类型
- 函数 < 50 行，避免深层嵌套（> 4 层）

---

## 三、红线原则

| 级别 | 规则 |
|------|------|
| 严重 | 禁止 copy-paste 重复代码 |
| 严重 | 禁止破坏现有功能 |
| 严重 | 禁止对错误方案妥协 |
| 重要 | 禁止盲目执行不加思考 |
| 重要 | 关键路径必须有错误处理 |

---

## 四、质量清单

### 4.1 完成前检查

- [ ] 代码可读、命名清晰
- [ ] 函数小（< 50 行）
- [ ] 文件聚焦（< 800 行）
- [ ] 无深层嵌套（> 4 层）
- [ ] 正确的错误处理
- [ ] 无 console.log 语句
- [ ] 无硬编码值
- [ ] 使用不可变模式

### 4.2 完成后清理

- 删除临时文件
- 删除注释掉的废弃代码
- 删除未使用的导入
- 删除调试日志（console.log）

---

## 五、测试要求

### 5.1 最低覆盖率：80%

| 测试类型 | 范围 | 工具 |
|----------|------|------|
| 单元测试 | 函数、工具、组件 | Jest/Vitest |
| 集成测试 | API 端点、数据库操作 | Supertest |
| E2E 测试 | 关键用户流程 | Playwright |

### 5.2 TDD 强制流程

1. 写测试（RED）
2. 运行测试 -- 应该失败
3. 写最小实现（GREEN）
4. 运行测试 -- 应该通过
5. 重构（IMPROVE）
6. 验证覆盖率（80%+）
